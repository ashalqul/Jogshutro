<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Cleanup Volunteer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #E8F7DD;
            color: #151B1F;
            text-align: center;
            padding: 20px;
            position: relative;
        }

        h1 {
            color: #374148;
            margin-top: 72px;
            margin-bottom: 20px;
            font-size: 19px;
        }

        #map {
            width: 100%;
            height: 400px;
            border: 2px solid #374148;
            margin-bottom: 20px;
        }

        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #374148;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        input,
        textarea,
        select {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #66B539;
            border-radius: 5px;
            box-sizing: border-box;
            color: #ffffff;
            background-color: #151B1F;
        }

        button {
            background-color: #66B539;
            color: #E8F7DD;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #4E8A2F;
        }

        button#locate-button,
        button#mark-area-button {
            margin: 10px;
        }

        #login-button-container {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        #account-buttons {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        .delete-marker-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>

<body>
    <div id="account-buttons">
        <button id="delete-account-button" style="display: none;">Delete Account</button>
        <button id="logout-button" style="display: none;">Logout</button>
    </div>
    <div id="login-button-container">
        <button id="login-button">Login with Google</button>
    </div>
    <h1>Want to create/request a new project?</h1>
    <div id="map"></div>
    <button id="locate-button">Locate Me</button>
    <button id="mark-area-button">Mark Area</button>
    <form id="report-form">
        <input type="text" id="project-name" placeholder="Project Name" required>
        <select id="project-type" required>
            <option value="cleanup">Cleanup</option>
            <option value="calligraphy">Calligraphy</option>
        </select>
        <input type="text" id="location" placeholder="Enter Location" required>
        <input type="file" id="photo">
        <textarea id="description" placeholder="Description"></textarea>
        <button type="submit">Submit</button>
    </form>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDAjjHIa2ZPqQ_Ybqp-uHbOleKwTV7AQAc",
            authDomain: "lecor-f87a8.firebaseapp.com",
            projectId: "lecor-f87a8",
            storageBucket: "lecor-f87a8.appspot.com",
            messagingSenderId: "606158282239",
            appId: "1:606158282239:web:40537977bdf29e86059bca",
            measurementId: "G-21F11LBMR6",
            databaseURL: "https://lecor-f87a8-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const rtdb = firebase.database();

        let map;
        let isMarking = false;
        let currentMarkers = [];
        let markerCount = 0;
        const maxMarkers = 1;

        function initMap() {
            map = L.map('map').setView([23.8103, 90.4125], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            loadMarkersFromFirestore();

            map.on('click', (e) => {
                if (isMarking && markerCount < maxMarkers) {
                    const projectName = prompt("Enter project name:");
                    if (!projectName) return;
                    document.getElementById('project-name').value = projectName;
                    const projectType = document.getElementById('project-type').value;
                    const color = getProjectColor(projectType);

                    const marker = L.circleMarker(e.latlng, {
                        color: color,
                        radius: 8
                    }).addTo(map)
                        .bindPopup(`Project: ${projectName}<br>Type: ${projectType}<br><button onclick="openChatroom('${projectName}')">Open Chatroom</button>`)
                        .openPopup();

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-marker-btn';
                    deleteButton.textContent = 'X';
                    deleteButton.onclick = () => {
                        map.removeLayer(marker);
                        currentMarkers = currentMarkers.filter(m => m.marker !== marker);
                        markerCount--;
                        if (markerCount < maxMarkers) {
                            isMarking = true;
                            document.getElementById('mark-area-button').textContent = 'Stop Marking';
                        }
                    };

                    marker.getElement().appendChild(deleteButton);

                    currentMarkers.push({ marker, projectName, projectType, location: e.latlng });
                    markerCount++;
                    if (markerCount >= maxMarkers) {
                        isMarking = false;
                        document.getElementById('mark-area-button').textContent = 'Mark Area';
                    }

                    createChatroom(projectName);
                }
            });
        }

        async function loadMarkersFromFirestore() {
            const snapshot = await db.collection("projects").get();
            snapshot.forEach(doc => {
                const data = doc.data();
                const location = data.location;
                const projectType = data.type;
                const color = getProjectColor(projectType);

                L.circleMarker([location.latitude, location.longitude], {
                    color: color,
                    radius: 8
                }).addTo(map)
                    .bindPopup(`Project: ${data.name}<br>Type: ${data.type}<br>Description: ${data.description}<br><button onclick="openChatroom('${data.name}')">Open Chatroom</button>`)
                    .openPopup();
            });
        }

        function locateUser() {
            map.locate({ setView: true, maxZoom: 16 });

            map.on('locationfound', (e) => {
                L.marker(e.latlng).addTo(map)
                    .bindPopup('You are here!')
                    .openPopup();
                map.setView(e.latlng, 16);
            });

            map.on('locationerror', () => {
                alert('Could not get your location.');
            });
        }

        function getProjectColor(type) {
            if (type === 'cleanup') {
                return '#3aeb34'; // Light Green for Cleanup
            } else if (type === 'calligraphy') {
                return '#349beb'; // Light Purple for Calligraphy
            }
            return '#000000'; // Default to black if no type is selected
        }

        document.getElementById('locate-button').addEventListener('click', locateUser);

        document.getElementById('mark-area-button').addEventListener('click', () => {
            isMarking = !isMarking;
            document.getElementById('mark-area-button').textContent = isMarking ? 'Stop Marking' : 'Mark Area';
        });

        document.getElementById('report-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const projectName = document.getElementById('project-name').value;
            const projectType = document.getElementById('project-type').value;
            const location = document.getElementById('location').value;
            const description = document.getElementById('description').value;
            const fileInput = document.getElementById('photo').files[0];

            let imageUrl = '';

            if (fileInput) {
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`project_photos/${fileInput.name}`);
                await fileRef.put(fileInput);
                imageUrl = await fileRef.getDownloadURL();
            }

            await db.collection('projects').add({
                name: projectName,
                type: projectType,
                location,
                description,
                imageUrl,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

            alert('Project submitted successfully!');
            document.getElementById('report-form').reset();
        });

        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('login-button').style.display = 'none';
                document.getElementById('logout-button').style.display = 'block';
document.getElementById('logout-button').style.marginTop = '5px';
document.getElementById('logout-button').style.marginBottom = '10px';

                document.getElementById('delete-account-button').style.display = 'block';
document.getElementById('logout-button').style.marginTop = '5px'; // Adjust as needed
            } else {
                document.getElementById('login-button').style.display = 'block';
                document.getElementById('logout-button').style.display = 'none';
document.getElementById('logout-button').style.marginTop = '5px';
document.getElementById('logout-button').style.marginBottom = '10px';
        
                document.getElementById('delete-account-button').style.display = 'none';
document.getElementById('delete-account-button').style.marginBottom = '5px'; // Adjust as needed               
            }
        });

        document.getElementById('login-button').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then((result) => {
                console.log('User logged in');
            }).catch((error) => {
                console.error('Error logging in:', error);
            });
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log('User logged out');
            }).catch((error) => {
                console.error('Error logging out:', error);
            });
        });

        document.getElementById('delete-account-button').addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                user.delete().then(() => {
                    console.log('Account deleted');
                }).catch((error) => {
                    console.error('Error deleting account:', error);
                });
            }
        });

        function createChatroom(projectName) {
            rtdb.ref(`chatrooms/${projectName}`).set({
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function openChatroom(projectName) {
            window.open(`/chatroom.html?project=${projectName}`, '_blank');
        }

        window.onload = initMap;
    </script>
</body>

</html>
